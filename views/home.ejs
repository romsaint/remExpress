<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="./static/home.css">
</head>

<body class="bg-gray-50">
    <div class="container-header">
        <%-include('./partials/header')%>
        <div class="inner-container">
            <div class="alert-wrap">

            </div>

            <div class="for-tag-text">

            </div>

            <div class="main">
                
            </div>
                <div class="pagination">
                    <div class="flex pagination-flex">
                        <!-- Previous Button -->
                        <a href=""  class="bg-slate-200 link-prev flex items-center justify-center px-4 h-10 me-3 text-base font-medium text-gray-500 border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                            <svg class="w-3.5 h-3.5 me-2 rtl:rotate-180" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5H1m0 0 4 4M1 5l4-4"/>
                            </svg>
                            Previous
                        </a>
                        <a href=""  class="bg-slate-200 link-next flex items-center justify-center px-4 h-10 text-base font-medium text-gray-500 border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                            Next
                            <svg class="w-3.5 h-3.5 ms-2 rtl:rotate-180" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
                            </svg>
                        </a>
                    </div>
                    
            </div>
        </div>
    </div>
    
    <div class="number-of-pages" id=""></div>

    <script>     
        let currentPage = 0;

        function loadTodoItems(page) {
            $.ajax({
                url: `/homeData/${page}`,
                method: "get",
                headers: {
                    'Authorization': `Bearer ${localStorage.token}`
                },
                success: res => {
                    if(res.count === 0){
                        $('.main > *').hide()
                        $('.main').append(`
                            <div class="empty">
                                <center>
                                    <h1>There are no entries.</h1>
                                </center>
                            </div>
                            <div class="empty-2">
                                <center>
                                    <h1>Never!</h1>
                                </center>
                            </div>
                        `)
                    }else{
                        $('.number-of-pages').attr('id', res.count)
                        $('.sector__main').remove(); // Remove existing items
    
                        for (let i = 0; i < res.todoData.length; i++) {
    
                            $('.main').append(`
                            <div class="sector__main">
                                <div class="inner-sector__main">
                                    <div class="title">
                                        <center>
                                            <h1 class="text-title">${res.todoData[i].title}</h1>
                                        </center>
                                        <div class="count-todo">
                                            <h1 class="h1__count-todo">${i + 1}</h1>
                                        </div>
                                    </div>
                                    <div class="description description-${i + 1}">
                                        <p class="text-descripton ">
                                            ${res.todoData[i].description}
                                        </p>
                                    </div>
    
                                    <form action="/complete/${res.todoData[i]._id}" method="post" class="form-complete form-complete-${res.todoData[i]._id}">
                                        <div class="is-confirm is-confirm-${i + 1}">
                                            <button type="submit" class="button__is-confirm button__is-confirm-${i + 1}">Not completed</button>
                                        </div>    
                                    </form>
    
                                    <div class="tags">
                                        <ul class="inner-tags inner-tags-${i + 1}">

                                        </ul>
                                    </div>
                                    <div class="date">
                                        <li class="text-date">${new Date(res.todoData[i].date_created).toLocaleDateString()}</li>
                                    </div>
                                    <div class="wrap__delete">
                                        <form class="form-delete form-delete${res.todoData[i]._id}" action="/delete/${res.todoData[i]._id}" method="post">
                                            <button type="submit" class="delete-btn">Delete</button>
                                        </form>
                                    </div>
                                </div>
                            </div>`)
                        
                             
                            for (let tag of res.todoData[i].tags) {
                                $(`.inner-tags-${i + 1}`).append(`
                                    <a href="/tag-search-data/${tag}" class="link-tag" id="${tag}">
                                        <li class="tag">${tag}</li>
                                    </a>
                                `);
                            }

                        }

                        //   END CYCLE        ///
                        $(`.form-delete`).submit(e => {
                            e.preventDefault()     
                            const form = $(e.currentTarget)

                            $.ajax({
                                url: form.attr('action'),
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${localStorage.token}`
                                },
                                success: res => {
                                    $('.wrap__alert-line').hide()
                                    $('.alert-inner').hide()
                                    
                                    $('.alert-wrap').append(`
                                        <div class="wrap__alert-line">
                                            <div class="alert-line" style="background-color: ${res.lineColor};"></div>
                                        </div>
                                        <div class="alert-inner">
                                            <div class="alert" style="background-color: ${res.color};">
                                                <div class="message">
                                                    <p>${res.message}</p>
                                                    <div class="wrap__close-alert">
                                                        <a class="a__close-alert">
                                                            <svg viewBox="0 0 24 24" class="close-alert" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path opacity="0.4" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="#ffffff"></path> <path d="M13.0594 12.0001L15.3594 9.70011C15.6494 9.41011 15.6494 8.93011 15.3594 8.64011C15.0694 8.35011 14.5894 8.35011 14.2994 8.64011L11.9994 10.9401L9.69937 8.64011C9.40937 8.35011 8.92937 8.35011 8.63938 8.64011C8.34938 8.93011 8.34938 9.41011 8.63938 9.70011L10.9394 12.0001L8.63938 14.3001C8.34938 14.5901 8.34938 15.0701 8.63938 15.3601C8.78938 15.5101 8.97937 15.5801 9.16937 15.5801C9.35937 15.5801 9.54937 15.5101 9.69937 15.3601L11.9994 13.0601L14.2994 15.3601C14.4494 15.5101 14.6394 15.5801 14.8294 15.5801C15.0194 15.5801 15.2094 15.5101 15.3594 15.3601C15.6494 15.0701 15.6494 14.5901 15.3594 14.3001L13.0594 12.0001Z" fill="#ffffff"></path> </g></svg>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `)
                
                                    $('.a__close-alert').on('click', (e) => {
                                        $('.wrap__alert-line').hide()
                                        $('.alert-inner').hide()
                                    })
                
                                    loadTodoItems(currentPage);
                                }
                            })
                        })

                        $('.form-complete').submit(e => {
                            e.preventDefault()
                            const form = $(e.currentTarget)

                            $.ajax({
                                url: form.attr('action'),
                                method: "post",
                                headers: {
                                    'Authorization': `Bearer ${localStorage.token}`
                                },
                                success: res => {
                                    $('.wrap__alert-line').hide()
                                    $('.alert-inner').hide()
                                    
                                    $('.alert-wrap').append(`
                                        <div class="wrap__alert-line">
                                            <div class="alert-line" style="background-color: ${res.lineColor};"></div>
                                        </div>
                                        <div class="alert-inner">
                                            <div class="alert" style="background-color: ${res.color};">
                                                <div class="message">
                                                    <p>${res.message}</p>
                                                    <div class="wrap__close-alert">
                                                        <a class="a__close-alert">
                                                            <svg viewBox="0 0 24 24" class="close-alert" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path opacity="0.4" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="#ffffff"></path> <path d="M13.0594 12.0001L15.3594 9.70011C15.6494 9.41011 15.6494 8.93011 15.3594 8.64011C15.0694 8.35011 14.5894 8.35011 14.2994 8.64011L11.9994 10.9401L9.69937 8.64011C9.40937 8.35011 8.92937 8.35011 8.63938 8.64011C8.34938 8.93011 8.34938 9.41011 8.63938 9.70011L10.9394 12.0001L8.63938 14.3001C8.34938 14.5901 8.34938 15.0701 8.63938 15.3601C8.78938 15.5101 8.97937 15.5801 9.16937 15.5801C9.35937 15.5801 9.54937 15.5101 9.69937 15.3601L11.9994 13.0601L14.2994 15.3601C14.4494 15.5101 14.6394 15.5801 14.8294 15.5801C15.0194 15.5801 15.2094 15.5101 15.3594 15.3601C15.6494 15.0701 15.6494 14.5901 15.3594 14.3001L13.0594 12.0001Z" fill="#ffffff"></path> </g></svg>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `)
            
                                    $('.a__close-alert').on('click', (e) => {
                                        $('.wrap__alert-line').hide()
                                        $('.alert-inner').hide()
                                    })
                                    loadTodoItems(currentPage);
                                    
                                }
                            })
                        })

                        $('.link-tag').click(function(e) {
                            e.preventDefault();
                            var tag = $(this).attr('id')

                            $.ajax({
                                url: `/tag-search-data/${tag}`,
                                method: "get",
                                headers: {
                                    'Authorization': `Bearer ${localStorage.token}`
                                },
                                success: function(res) {
                                    $('.main > *').hide()
                                    $('.for-tag-text').append(`
                                        <center>
                                            <div class="wrap__tag-search-text">
                                                <h1 class="tag-search-text">
                                                    All entries with the tag - ${tag}
                                                </h1>
                                            </div>
                                        </center>
                                    `)
                                    for (let i = 0; i < res.listId.length; i++) {
                                        $('.main').append(`
                                        <div class="sector__main">
                                            <div class="inner-sector__main">
                                                <div class="title">
                                                    <center>
                                                        <h1 class="text-title">${res.listId[i].title}</h1>
                                                    </center>
                                                    <div class="count-todo">
                                                        <h1 class="h1__count-todo">${i + 1}</h1>
                                                    </div>
                                                </div>
                                                <div class="description description-${i + 1}">
                                                    <p class="text-descripton ">
                                                        ${res.listId[i].description}
                                                    </p>
                                                </div>
                
                                                <form action="/complete/${res.listId[i]._id}" method="get" class="form-complete">
                                                    <div class="is-confirm is-confirm-${i + 1}">
                                                        <button type="submit" class="button__is-confirm button__is-confirm-${i + 1}">Not completed</button>
                                                    </div>    
                                                </form>
                
                                                <div class="tags">
                                                    <ul class="inner-tags inner-tags-${i + 1}">
                                                    </ul>
                                                </div>
                                                <div class="date">
                                                    <li class="text-date">${new Date(res.listId[i].date_created).toLocaleDateString()}</li>
                                                </div>
                                            </div>
                                        </div>`)

                                            //            TAG FOR TAG BOOOM
                                        for (let tag of res.listId[i].tags) {
                                            $(`.inner-tags-${i + 1}`).append(`
                                                <a href="/tag-search-data/${tag}" class="link-tag" id="${tag}">
                                                    <li class="tag">${tag}</li>
                                                </a>
                                            `);
                                        }
                                        //
                                        $('.button__is-confirm').hover((e) => {
                                            if (e.type === 'mouseenter') {
                                                $(e.target).text('Complete');
                                                $(e.target).css({ 'background-color': "rgb(170 253 189 / 83%)" });
                                            } else {
                                                $(e.target).text('Not completed');
                                                $(e.target).css({ 'background-color': "rgb(255, 145, 145)" });
                                            }
                                        });

                                        
                                    }
                                    
                                    for (let j = 1; j <= res.count; j++) {
                                        let hDescription = $(`.description-${j}`).height();
                                        let finallResH = 170 - hDescription;
                                        if (hDescription < 170) {
                                            $(`.is-confirm-${j}`).css({ 'margin-top': `${finallResH}px` });
                                        }
                                    }
                                }
                            });
                        });
                    }

                    $('.form-complete').submit(e => {
                        e.preventDefault()
                        const form = $('.form-complete')
                        $.ajax({
                            url: form.attr('action'),
                            method: "get",
                            headers: {
                                'Authorization': `Bearer ${localStorage.token}`
                            },
                            success: res => {
                                $('.wrap__alert-line').hide()
                                $('.alert-inner').hide()
                                
                                $('.alert-wrap').append(`
                                    <div class="wrap__alert-line">
                                        <div class="alert-line" style="background-color: ${res.lineColor};"></div>
                                    </div>
                                    <div class="alert-inner">
                                        <div class="alert" style="background-color: ${res.color};">
                                            <div class="message">
                                                <p>${res.message}</p>
                                                <div class="wrap__close-alert">
                                                    <a class="a__close-alert">
                                                        <svg viewBox="0 0 24 24" class="close-alert" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path opacity="0.4" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="#ffffff"></path> <path d="M13.0594 12.0001L15.3594 9.70011C15.6494 9.41011 15.6494 8.93011 15.3594 8.64011C15.0694 8.35011 14.5894 8.35011 14.2994 8.64011L11.9994 10.9401L9.69937 8.64011C9.40937 8.35011 8.92937 8.35011 8.63938 8.64011C8.34938 8.93011 8.34938 9.41011 8.63938 9.70011L10.9394 12.0001L8.63938 14.3001C8.34938 14.5901 8.34938 15.0701 8.63938 15.3601C8.78938 15.5101 8.97937 15.5801 9.16937 15.5801C9.35937 15.5801 9.54937 15.5101 9.69937 15.3601L11.9994 13.0601L14.2994 15.3601C14.4494 15.5101 14.6394 15.5801 14.8294 15.5801C15.0194 15.5801 15.2094 15.5101 15.3594 15.3601C15.6494 15.0701 15.6494 14.5901 15.3594 14.3001L13.0594 12.0001Z" fill="#ffffff"></path> </g></svg>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `)
        
                                $('.a__close-alert').on('click', (e) => {
                                    $('.wrap__alert-line').hide()
                                    $('.alert-inner').hide()
                                })
                                loadTodoItems(currentPage);
                                
                            }
                        })
                    })
            
                    //          SLKDASDASA
                    $('.button__is-confirm').hover((e) => {
                        if (e.type === 'mouseenter') {
                            $(e.target).text('Complete');
                            $(e.target).css({ 'background-color': "rgb(170 253 189 / 83%)" });
                        } else {
                            $(e.target).text('Not completed');
                            $(e.target).css({ 'background-color': "rgb(255, 145, 145)" });
                        }
                    });


                    for (let j = 1; j <= res.count; j++) {
                        let hDescription = $(`.description-${j}`).height();
                        let finallResH = 170 - hDescription;
                        if (hDescription < 170) {
                            $(`.is-confirm-${j}`).css({ 'margin-top': `${finallResH}px` });
                        }
                    }
                }
            });
        }

        loadTodoItems(currentPage);

        $('.link-next').click(e => {
            e.preventDefault();
            currentPage++;

            let countPages = $('.number-of-pages').attr('id')
            if(currentPage > Math.round(parseInt(countPages) / 2) - 1){
                currentPage = currentPage -1
            }

            loadTodoItems(currentPage);
        });

        $('.link-prev').click(e => {
            e.preventDefault();
            if (currentPage > 0) {
                currentPage--;
                
                if(currentPage < 0){
                    currentPage = 0
                }
                loadTodoItems(currentPage);
            }
        });
    </script>
</body>
</html>